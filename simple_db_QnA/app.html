<!DOCTYPE html>
<html>
<head>
    <title>DataTables from API Call</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
</head>
<body>

    <h1>Disease Claims from API</h1>

    <div>
        <input type="text" id="questionInput" placeholder="Enter your query here (e.g., 'Show top 10 diseases')" style="width: 400px;">
        <button id="submitQuestion">Get Data</button>
    </div>

    <div id="tableContainer" style="display: none;">
        <table id="myDataTable" class="display" style="width:400px">
            <thead>
                </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div id="loadingMessage" style="display: none; color: blue;">Loading data...</div>
    <div id="errorMessage" style="display: none; color: red;"></div>

    <script>
        $(document).ready(function() {
            // Reference to the DataTable instance
            let dataTableInstance = null;

            // Function to parse the Python-like string result
/*             function parseResultString(resultString) {
                let dataArray = [];
                try {
                    const tupleStrings = resultString.slice(1, -1).split(/\), \(/);

                    tupleStrings.forEach(tupleStr => {
                        const cleanedTupleStr = tupleStr.replace(/^\(|\)$/g, '');
                        const elements = cleanedTupleStr.match(/'[^']+'|\d+/g);

                        const row = elements.map(el => {
                            if (el.startsWith("'") && el.endsWith("'")) {
                                return el.slice(1, -1);
                            }
                            return isNaN(el) ? el : Number(el);
                        });
                        dataArray.push(row);
                    });
                } catch (e) {
                    console.error("Error parsing result string:", e);
                    return null; // Return null on error
                }
                return dataArray;
            } */

            // Function to fetch data from the API and populate the table
            $('#submitQuestion').on('click', function() {
                const question = $('#questionInput').val();
                if (!question) {
                    $('#errorMessage').text('Please enter a question.').show();
                    $('#tableContainer').hide();
                    return;
                }

                $('#loadingMessage').show();
                $('#errorMessage').hide();
                $('#tableContainer').hide(); // Hide table while loading

                // Replace 'YOUR_API_ENDPOINT' with the actual URL of your FastAPI endpoint
                const apiEndpoint = 'http://127.0.0.1:8123/api/v2/qna'; // e.g., 'http://127.0.0.1:8000/query' or whatever your FastAPI endpoint is

                $.ajax({
                    url: apiEndpoint,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ question: question }), // Send the question as JSON
                    success: function(response) {
                        $('#loadingMessage').hide();

                        if (response && response.result) {
                            const parsedData = response.result;

                            if (parsedData && parsedData.length > 0) {
                                // Extract headers (first row)
                                //const headers = parsedData.shift();
                                
                                const headers = response.columns;
                                
                                // Format headers for DataTables columns option
                                const columns = headers.map(header => ({ title: header }));

                                // Destroy existing DataTable instance if it exists
                                if (dataTableInstance) {
                                    dataTableInstance.destroy();
                                    $('#myDataTable thead').empty(); // Clear old headers
                                    $('#myDataTable tbody').empty(); // Clear old body
                                }

                                // Initialize DataTables with new data
                                dataTableInstance = $('#myDataTable').DataTable({
                                    data: parsedData,
                                    columns: columns,
                                    paging: true,
                                    searching: true,
                                    ordering: true,
                                    info: true,
                                    destroy: true // Allow re-initialization if needed later
                                });
                                $('#tableContainer').show(); // Show table after data is loaded
                            } else {
                                $('#errorMessage').text('No data returned from the API or result was empty.').show();
                                $('#tableContainer').hide();
                            }
                        } else {
                            $('#errorMessage').text('Invalid API response format (missing "result" key).').show();
                            $('#tableContainer').hide();
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        $('#loadingMessage').hide();
                        $('#errorMessage').text('API Error: ' + textStatus + ' - ' + errorThrown).show();
                        console.error("AJAX error:", textStatus, errorThrown, jqXHR.responseText);
                        $('#tableContainer').hide();
                    }
                });
            });
        });
    </script>

</body>
</html>