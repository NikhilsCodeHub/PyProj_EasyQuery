<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.dataTables.css">
    <link rel="stylesheet" type="text/css" href="css/custom.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link href="css/materialdesignicons.min.css" rel="stylesheet" />

    <script src="js/loader.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">


    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
    <style>

        .mermaid {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .visit-counter {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        .visit-counter i {
            margin-right: 5px;
            color: #007bff;
        }

        #unique-visitors-count, #total-visits-count {
            font-weight: bold;
            color: #495057;
        }
</style>
</head>
<body class="navbar-fixed sidebar-fixed" id="body">
    <div id="main-wrapper">
        <!-- Sidebar -->
        <aside class="left-sidebar sidebar-dark" id="left-sidebar">
            <div id="sidebar-container"></div>
        </aside>    
        <div class="page-wrapper" >
            <header class="main-header" id="header">
                <nav class="navbar navbar-expand-lg navbar-light" id="navbar" style="justify-content: left;">
                <button id="sidebar-toggler" class="sidebar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                </button>
                <span class="page-title">EasyQuery</span>
                </nav>              
            </header>

            <div class="content-wrap">
                <div class="container-fluid">
                    <div class="row">
                            <div class="card card-default mt-4">
                                <div class="card-header" style="background-color: #c8c9c9;">
                                    <h3>Design</h2>
                                </div>
                                <div class="card-body">  
                                    <div class="col-xl-16">
                                    <p class="lead">
                                        <h4>An LLM-Powered Data Query System</h4>
                                        <p>The sequence diagram illustrates a streamlined flow, enabling users to obtain database insights through natural language—without direct exposure to database mechanics or sensitive information.</p>

                                        <h5>Process Design Overview</h5>
                                        <ul>
                                            <li><strong>User Interaction</strong>: Users initiate queries using everyday language in a browser interface.</li>
                                            <li><strong>API Layer Mediation</strong>: The API Layer acts as a secure intermediary, forwarding questions and managing all interactions with the database and the LLM.</li>
                                            <li><strong>Schema Discovery</strong>: Before generating a query, the API Layer requests the database schema to ensure the correct context for the LLM.</li>
                                            <li><strong>LLM Query Generation</strong>: The LLM receives both the user’s question and schema details, producing an accurate SQL query that matches the user’s intent.</li>
                                            <li><strong>Database Execution</strong>: The API Layer executes the generated SQL on the database and retrieves the results.</li>
                                            <li><strong>Results Delivery</strong>: The answers are packaged as JSON and relayed back to the user’s browser.</li>
                                        </ul>

                                        <h5>Benefits of Data Privacy in This Design</h5>
                                        <ul>
                                            <li><strong>No Direct Database Access</strong>: Users never interact with the database directly. All communications pass through the API Layer, reducing attack surfaces and ensuring sensitive information is never exposed.</li>
                                            <li><strong>Controlled Schema Sharing</strong>: The LLM only receives schema details, not actual data, limiting the exposure of confidential or sensitive data structures.</li>
                                            <li><strong>Limited Data Scope</strong>: Only query results needed to fulfill the user’s request are shared back—never the full dataset—minimizing risk of data leakage.</li>
                                            <li><strong>Isolation of Sensitive Operations</strong>: SQL generation is isolated within a trusted environment, preventing unauthorized users from crafting malicious queries.</li>
                                            <li><strong>Auditing and Monitoring</strong>: Centralizing queries through the API Layer allows for comprehensive logging, audit trails, and detection of anomalous access patterns for enhanced security.</li>
                                        </ul>

                                        <p>This architecture combines ease of use with robust privacy controls, allowing users to retrieve valuable insights without compromising database integrity or exposing confidential information.</p>
                                    </p>
                                
                                
                                    <pre class="mermaid">
                                        sequenceDiagram
                                            participant Client Browser
                                            participant API Layer
                                            participant SQL DB
                                            participant LLM Model
                                            Client Browser->>API Layer: User Question
                                            API Layer->>SQL DB: Request DB Schema
                                            SQL DB->>API Layer: DB Schema Response
                                            API Layer->>LLM Model: User Question and DB Schema
                                            LLM Model->>API Layer: Generated SQL Query
                                            API Layer->>SQL DB: Execute SQL Query
                                            SQL DB->>API Layer: Query Results
                                            API Layer->>Client Browser: JSON formatted data
                                    </pre>
                                    </div>
                                </div>  
                                <div class="card-body">
                                    <h5>Alternate Approach in case of large DB Schema</h5>
                                    <p>This architecture addresses the case where there are large number of DB objects involved. Instead of sending the schema info for all Objects (<b>which might consume a lot of tokens</b>), it first gets a list of relevant DB objects using a prelim call to LLM. Then based on that only send the schema that pertains to the user query.</p>
                                    <pre class="mermaid">
                                        sequenceDiagram
                                            participant Client Browser
                                            participant Service Layer
                                            participant SQL DB
                                            participant Vector DB
                                            participant LLM
                                            Client Browser->>Service Layer: User Question
                                            Service Layer->>SQL DB: Request SQL Object Relationship 
                                            SQL DB->>Service Layer: Response SQL Objects List
                                            Service Layer->>LLM : User Question and SQL Object List
                                            LLM->>Service Layer: Relevant Object List
                                            Service Layer->>SQL DB: Request Relevant DB Schema
                                            SQL DB->>Service Layer: DB Schema Response
                                            Service Layer->>LLM : User Question and Relevant DB Schema
                                            LLM ->>Service Layer: Generated SQL Query
                                            Service Layer->>SQL DB: Execute SQL Query
                                            SQL DB->>Service Layer: Query Results
                                            Service Layer->>Client Browser: JSON formatted data
                                    </pre>                                    
                                </div>
                           
                            </div>
                        </div> 
                    </div>
                
                   
                </div>
                <div class="align-items-center" >
                    <span class="visit-counter me-3" id="unique-visitors-counter">
                        <i class="mdi mdi-account-multiple"></i> Unique Visitors: <span id="unique-visitors-count">Loading...</span>
                    </span>
                    <span class="visit-counter" id="total-visits-counter">
                        <i class="mdi mdi-eye"></i> Total Visits: <span id="total-visits-count">Loading...</span>
                    </span>
                </div>                  
            </div>
        </div>
    </div>
    
    <!-- html component loader -->
    <script lang="javascript">
        $(document).ready(function() {
            load_sidebar_dataset();
            loadVisitCount();
        });
    </script>
    <script>
        function loadVisitCount() {
            fetch('/api/v1/visit-count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('unique-visitors-count').textContent = data.unique_visitors.toLocaleString();
                    document.getElementById('total-visits-count').textContent = data.total_visits.toLocaleString();
                })
                .catch(error => {
                    console.error('Error fetching visit count:', error);
                    document.getElementById('unique-visitors-count').textContent = 'Error';
                    document.getElementById('total-visits-count').textContent = 'Error';
                });
        }

    </script>    
</body>
</html>